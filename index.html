<!DOCTYPE html>
<html>

<head>
    <title>Woordenboekspel</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style/main.css">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <style>
    	.form-signin {
			width: 100%;
			max-width: 400px;
			padding: 15px;
			margin: auto;
		}
		.form-signin .checkbox {
			font-weight: 400;
		}
		.form-signin .form-control {
			position: relative;
			box-sizing: border-box;
			height: auto;
			padding: 10px;
			font-size: 16px;
		}
		.form-signin .form-control:focus {
			z-index: 2;
		}
		.form-signin input[type="text"] {
			margin-bottom: 10px;
			border-top-left-radius: 0;
			border-top-right-radius: 0;
		}
    </style>	
</head>

<body class="text-center">
	<div class="container">
		<div class="row justify-content-md-center">
			<img class="mb-2" src="images/woordenboekspel.png" alt="" width="500">
		</div>
		<div class="row">
		    <form class="form-signin">
		        <h1 class="h3 mb-3 font-weight-normal">Welgekomen, jij daar!</h1>
		        <label for="username" class="sr-only">Wat is je username?</label>
		        <input type="text" id="username" class="form-control" placeholder="Username" required="" autofocus="">

		        <label for="inputRoomID" class="sr-only">Kamer nummer</label>
		        <input type="text" id="inputRoomID" class="form-control" placeholder="Kamer nummer" required="" autofocus="">
		        <a href="#" id="betreedKamer" class="btn btn-lg btn-primary btn-block disabled">Betreed kamer</a>

		        <p class="mt-3 mb-2 ">OF maak een nieuwe kamer</p>

		        <a href="#" id="createRoom" class="btn btn-lg btn-sm btn-primary btn-block disabled">Maak een kamer</a>
		        <p class="mt-5 mb-3 text-muted" id="errorlog"></p>
		    </form>
		</div>
	</div>
    <footer class="footer">
		<div class="container">
			<span class="text-muted">Door jouw liefste kapoen, <a href="">Yordi Verbeeck</a> van <a href="#">Sjarel</a></span>
		</div>
    </footer>


    <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-firestore.js"></script>
    <script>
		$(document).ready(function() {
			 // Your web app's Firebase configuration
		    var firebaseConfig = {
		        apiKey: "AIzaSyB1S5WKU4vVJHON2sEp1fk2hu0zH_Cxa0g",
		        authDomain: "woordenboekspel-a120d.firebaseapp.com",
		        databaseURL: "https://woordenboekspel-a120d.firebaseio.com",
		        projectId: "woordenboekspel-a120d",
		        storageBucket: "woordenboekspel-a120d.appspot.com",
		        messagingSenderId: "6191639396",
		        appId: "1:6191639396:web:9cbdf498bdc2fea47e6871",
		        measurementId: "G-X1MWL08VFS"
		    };
		    // Initialize Firebase
		    firebase.initializeApp(firebaseConfig);
		    firebase.analytics();
        	var db = firebase.firestore();

        	if($("#inputRoomID").val()!=""){
		        $('#betreedKamer').removeClass('disabled');   
        	}

        	$(document).on('click', '#createRoom', function(event) {
        		event.preventDefault();
        		$("#createRoom").html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
        		db.collection("rooms").add({
        			huidigWoord:1,
        			roomname: "",
        			timeStamp:new Date,
        			status:"new",
        			shortroom:makeid(8)
        		}).then(function(docRef){
        			//make user before redirect
        			console.log("roomid: "+docRef.id);
        			db.collection("rooms").doc(docRef.id).collection("users").add({
	        			allowed: true,
	        			createdDate: new Date,
	        			punten:0,
	        			username: $("#username").val().length!=0 ? $("#username").val() : "user-"+makeid(4),
	        			admin:true
	        		}).then(function(userdocRef){
	        			//make user before redirect
	        			console.log("roomid: "+userdocRef.id);
	        			localStorage.setItem("WBS-"+docRef.id,userdocRef.id);
	        			if(localStorage.getItem("WBS-"+docRef.id)==userdocRef.id){
	        				window.location.href ="kamer.html?kamer="+docRef.id;
	        			}else{
	        				alert("kan storage niet zetten :'( De serverowner wordt genotificeerd.");
	        				console.log("can't set localStorage");
	        			}
	        		}).catch(function(error) {
						console.error("Error creating user: ", error);
						alert("Er ging ergens iets mis, sorry!");
					});
        		}).catch(function(error) {
					console.error("Error adding document: ", error);
					$("#createRoom").text("Maak een kamer");
				});

        	}).on('click', '#betreedKamer', function(event) {
        		event.preventDefault();
        		if(!$(this).hasClass('disabled')){
        			$("#betreedKamer").html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
					var enteredId = $("#inputRoomID").val();
					db.collection('rooms').where('shortroom',"==",enteredId).orderBy('startedAt','desc').get().then(function(querySnapshot){
						if(!querySnapshot.empty){ 
							querySnapshot.forEach(function(doc) {	   			
								//make user before redirect
								db.collection("rooms").doc(doc.id).collection("users").add({
				        			allowed: true,
				        			createdDate: new Date,
				        			punten: 0,
				        			username: $("#username").val().length!=0 ? $("#username").val() : "user-"+makeid(4),
				        			admin: false
				        		}).then(function(userdocRef){
				        			//make user before redirect
				        			console.log("roomid: "+userdocRef.id);
				        			localStorage.setItem("WBS-"+doc.id,userdocRef.id);
				        			if(localStorage.getItem("WBS-"+doc.id)==userdocRef.id){
				        				window.location.href ="kamer.html?kamer="+doc.id;
				        			}else{
				        				alert("kan storage niet zetten :'( De serverowner wordt genotificeerd.");
				        				console.log("can't set localStorage");
				        			}
				        		}).catch(function(error) {
									console.error("Error creating user: ", error);
									alert("Er ging ergens iets mis, sorry!");
								});
							}).catch(function(error) {
								console.error("Error finding document: ", error);
								$("#betreedKamer").text("Betreed kamer");
							});
						}else{
							$("#errorlog").text("Invalid room!");
							$("#betreedKamer").text("Betreed kamer");
							console.log("room not found... "+enteredId)
						}
					});
        		}
        	}).on('keyup', '#inputRoomID', function(event) {
        		event.preventDefault();
        		if($(this).val().length !=0 && $("#username").val().length != 0)
		            $('#betreedKamer').removeClass('disabled');   
		        else
		            $('#betreedKamer').addClass('disabled');
	       	}).on('keyup', '#username', function(event) {
        		event.preventDefault();
        		if($(this).val().length !=0){
	           		$('#createRoom').removeClass('disabled');
        			if($("#inputRoomID").val().length != 0){
		           		$('#betreedKamer').removeClass('disabled');
		           	}
        		}
		        else{
		        	$('#createRoom').addClass('disabled');
        			if($("#inputRoomID").val().length != 0){
		           		$('#betreedKamer').addClass('disabled');
		           	}
		        }
	       	});


        	function makeid(length) {
			   var result           = '';
			   var characters       = 'abcdefghijklmnopqrstuvwxyz0123456789';
			   var charactersLength = characters.length;
			   for ( var i = 0; i < length; i++ ) {
			      result += characters.charAt(Math.floor(Math.random() * charactersLength));
			   }
			   return result;
			}
		});
    </script>
</body>

</html>